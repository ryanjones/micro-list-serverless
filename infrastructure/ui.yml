AWSTemplateFormatVersion: 2010-09-09
Description: micro-list-serverless UI

Parameters: 
  WebsiteDomain:
    Type: String
    Description: The root domain (e.g. cnn.com) of the website
  WebsiteHost:
    Type: String
    Description: The website host (e.g. www.cnn.com) for the website
  ZoneWildcardCertificateId: 
    Type: String
  ZoneRootCertificateId: 
    Type: String

Outputs:
  SiteBucketId:
    Value: !Ref SiteBucket
  SiteBucketWebsiteUrl:
    Value: !GetAtt SiteBucket.WebsiteURL
  CloudfrontDistributionDomainName:
    Value: !Ref WebsiteCloudfrontDistribution.DomainName

Resources:
  SiteBucket:
    Type: AWS::S3::Bucket
    Properties:
      AccessControl: PublicRead
      BucketName: !Ref WebsiteHost
      WebsiteConfiguration:
        IndexDocument: index.html
        # Hack: redirect errors to index.html to work with react-router
        ErrorDocument: index.html

  NakedDomainSiteBucketRedirect:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Ref WebsiteDomain
      WebsiteConfiguration:
        RedirectAllRequestsTo:
          HostName: !Join ['.', ['www', !Ref WebsiteDomain]]
          Protocol: https

  WebsiteCloudfrontLoggingBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: !Join ['-', [ !Ref WebsiteHost, 'logs' ] ]
    DependsOn: SiteBucket

  WebsiteCloudfrontDistribution:
      Type: "AWS::CloudFront::Distribution"
      Properties:
          DistributionConfig:
              Aliases:
                  - !Ref WebsiteHost
              Comment: "Distribution CDN for site"
              DefaultCacheBehavior:
                  Compress: true
                  ForwardedValues:
                      QueryString: false
                      Cookies:
                          Forward: "none"
                  TargetOriginId: "website"
                  ViewerProtocolPolicy: "redirect-to-https"
              DefaultRootObject: "index.html"
              Enabled: true
              HttpVersion: "http2"
              IPV6Enabled: true
              Logging:
                  Bucket: !Join ['.', [!Ref WebsiteCloudfrontLoggingBucket, 's3.amazonaws.com' ] ]
              Origins:
                  -
                      DomainName: !Join ['.', [!Ref SiteBucket, 's3-website-us-east-1.amazonaws.com' ] ]
                      Id: "website"
                      CustomOriginConfig:
                          HTTPPort: 80
                          OriginProtocolPolicy: http-only
              ViewerCertificate:
                  AcmCertificateArn: !Ref ZoneWildcardCertificateId
                  SslSupportMethod: sni-only

  NakedCloudfrontDistribution:
    Type: 'AWS::CloudFront::Distribution'
    Properties:
      DistributionConfig:
        Aliases:
          - !Ref WebsiteDomain
        Enabled: True
        Origins:
          - DomainName: !Select
              - 1
              - !Split ["//", !GetAtt SiteBucket.WebsiteURL]
            Id: origin
            CustomOriginConfig:
                HTTPPort: 80
                OriginProtocolPolicy: http-only
        DefaultCacheBehavior:
          TargetOriginId: origin
          DefaultTTL: 5
          MaxTTL: 30
          ForwardedValues:
            QueryString: false
          ViewerProtocolPolicy: redirect-to-https
        ViewerCertificate:
          AcmCertificateArn: !Ref ZoneRootCertificateId
          SslSupportMethod: sni-only